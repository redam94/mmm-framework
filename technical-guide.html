<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Guide | MMM Framework</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --color-primary: #8fa86a;
            --color-primary-dark: #6d8a4a;
            --color-accent: #6a8fa8;
            --color-accent-dark: #4a6d8a;
            --color-bg: #fafbf9;
            --color-bg-alt: #f0f2ed;
            --color-surface: #ffffff;
            --color-text: #2d3a2d;
            --color-text-muted: #5a6b5a;
            --color-border: #d4ddd4;
            --color-success: #6abf8a;
            --color-warning: #d4a86a;
            --color-danger: #c97067;
            --shadow-sm: 0 2px 8px rgba(45, 58, 45, 0.06);
            --shadow-md: 0 8px 24px rgba(45, 58, 45, 0.08);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.8;
            font-size: 17px;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(250, 251, 249, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 0;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'DM Serif Display', serif;
            font-size: 1.5rem;
            color: var(--color-primary-dark);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--color-text-muted);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition-smooth);
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--color-primary);
        }

        /* Layout */
        .page-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 5rem;
        }

        /* Sidebar */
        .sidebar {
            position: sticky;
            top: 5rem;
            height: calc(100vh - 5rem);
            overflow-y: auto;
            padding: 2rem;
            border-right: 1px solid var(--color-border);
            background: var(--color-bg);
        }

        .sidebar h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-muted);
            margin-bottom: 1rem;
            margin-top: 1.5rem;
        }

        .sidebar h3:first-child {
            margin-top: 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav a {
            display: block;
            padding: 0.5rem 0;
            color: var(--color-text-muted);
            text-decoration: none;
            font-size: 0.95rem;
            transition: var(--transition-smooth);
            border-left: 2px solid transparent;
            padding-left: 1rem;
            margin-left: -1rem;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            color: var(--color-primary);
            border-left-color: var(--color-primary);
        }

        .sidebar-nav .sub-item a {
            padding-left: 2rem;
            font-size: 0.9rem;
        }

        /* Main Content */
        .main-content {
            padding: 3rem 4rem;
            max-width: 900px;
        }

        .main-content h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .main-content h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.8rem;
            margin-top: 3rem;
            margin-bottom: 1rem;
            padding-top: 2rem;
            border-top: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .main-content h2:first-of-type {
            border-top: none;
            padding-top: 0;
            margin-top: 2rem;
        }

        .main-content h3 {
            font-size: 1.3rem;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            color: var(--color-text);
        }

        .main-content h4 {
            font-size: 1.1rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        .main-content p {
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .lead {
            font-size: 1.2rem;
            color: var(--color-text-muted);
            margin-bottom: 2rem;
        }

        /* Math blocks */
        .math-block {
            background: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        .math-block .katex {
            font-size: 1.1em;
        }

        .equation-label {
            float: right;
            color: var(--color-text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        /* Definition boxes */
        .definition {
            background: rgba(143, 168, 106, 0.1);
            border-left: 4px solid var(--color-primary);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .definition h4 {
            color: var(--color-primary-dark);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        /* Warning/Note boxes */
        .warning {
            background: rgba(201, 112, 103, 0.1);
            border-left: 4px solid var(--color-danger);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .warning h4 {
            color: var(--color-danger);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .note {
            background: rgba(106, 143, 168, 0.1);
            border-left: 4px solid var(--color-accent);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .note h4 {
            color: var(--color-accent-dark);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .caution {
            background: rgba(212, 168, 106, 0.15);
            border-left: 4px solid var(--color-warning);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .caution h4 {
            color: #b8860b;
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        /* Code blocks */
        pre {
            background: #2d3a2d;
            color: #e8ebe8;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background: var(--color-bg-alt);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        pre code {
            background: none;
            padding: 0;
        }

        /* Syntax highlighting */
        .keyword { color: #c792ea; }
        .function { color: #82aaff; }
        .string { color: #c3e88d; }
        .number { color: #f78c6c; }
        .comment { color: #676e95; font-style: italic; }
        .class { color: #ffcb6b; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        th {
            background: var(--color-bg-alt);
            font-weight: 600;
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(143, 168, 106, 0.05);
        }

        /* Model diagrams */
        .model-diagram {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }

        .model-diagram svg {
            max-width: 100%;
            height: auto;
        }

        /* When to use cards */
        .use-case-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .use-case-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.25rem;
        }

        .use-case-card.good {
            border-left: 3px solid var(--color-success);
        }

        .use-case-card.bad {
            border-left: 3px solid var(--color-danger);
        }

        .use-case-card h5 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .use-case-card p {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-bottom: 0;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0 1rem 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Links */
        a {
            color: var(--color-primary);
        }

        a:hover {
            text-decoration: underline;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(106, 191, 138, 0.15);
            color: #3d8b5a;
        }

        .badge-danger {
            background: rgba(201, 112, 103, 0.15);
            color: var(--color-danger);
        }

        /* Method comparison grid */
        .method-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .method-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .method-card h4 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: var(--color-primary-dark);
        }

        .method-card .use-for {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .page-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                top: auto;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--color-border);
            }

            .main-content {
                padding: 2rem;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .use-case-grid,
            .method-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-content">
            <a href="index.html" class="logo">MMM Framework</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="variable-selection.html">Variable Selection</a></li>
                <li><a href="#" class="active">Technical Guide</a></li>
                <li><a href="https://github.com/redam94/mmm-framework" target="_blank">GitHub</a></li>
            </ul>
        </div>
    </nav>

    <div class="page-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Getting Started</h3>
            <ul class="sidebar-nav">
                <li><a href="#overview">Overview</a></li>
                <li><a href="#bayesian-basics">Bayesian Basics</a></li>
                <li><a href="#choosing-model">Choosing a Model</a></li>
            </ul>

            <h3>Standard MMM</h3>
            <ul class="sidebar-nav">
                <li><a href="#standard">Model Structure</a></li>
                <li><a href="#standard-adstock">Adstock Transformation</a></li>
                <li><a href="#standard-saturation">Saturation Functions</a></li>
                <li><a href="#standard-priors">Prior Specification</a></li>
            </ul>

            <h3>Nested Model</h3>
            <ul class="sidebar-nav">
                <li><a href="#nested">Model Structure</a></li>
                <li><a href="#nested-mediators">Mediator Types</a></li>
                <li><a href="#nested-identification">Identification</a></li>
            </ul>

            <h3>Multivariate Model</h3>
            <ul class="sidebar-nav">
                <li><a href="#multivariate">Model Structure</a></li>
                <li><a href="#cross-effects">Cross-Effects</a></li>
                <li><a href="#multivariate-correlation">Correlated Errors</a></li>
            </ul>

            <h3>Variable Selection</h3>
            <ul class="sidebar-nav">
                <li><a href="#variable-selection">Overview & Cautions</a></li>
                <li><a href="#vs-horseshoe">Regularized Horseshoe</a></li>
                <li><a href="#vs-spike-slab">Spike-and-Slab</a></li>
                <li><a href="#vs-lasso">Bayesian LASSO</a></li>
                <li><a href="#vs-interpretation">Interpretation</a></li>
            </ul>

            <h3>Advanced Topics</h3>
            <ul class="sidebar-nav">
                <li><a href="#combined">Combined Model</a></li>
                <li><a href="#hierarchical">Hierarchical Structure</a></li>
                <li><a href="#diagnostics">Model Diagnostics</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <h1>Technical Guide</h1>
            <p class="lead">
                A comprehensive reference for data scientists implementing Bayesian Marketing Mix Models.
                This guide covers the mathematical foundations, model specifications, and practical considerations
                for each model type.
            </p>

            <!-- Overview -->
            <h2 id="overview">Overview</h2>
            <p>
                Marketing Mix Modeling (MMM) estimates the incremental impact of marketing activities on business
                outcomes like sales or conversions. This framework implements MMM using Bayesian inference,
                which provides several advantages over traditional frequentist approaches:
            </p>
            <ul>
                <li><strong>Uncertainty quantification:</strong> Full posterior distributions, not just point estimates</li>
                <li><strong>Prior incorporation:</strong> Domain knowledge can be encoded in priors</li>
                <li><strong>Regularization:</strong> Priors act as natural regularizers, preventing overfitting</li>
                <li><strong>Decision-ready outputs:</strong> Credible intervals directly answer "how confident are we?"</li>
            </ul>

            <!-- Bayesian Basics -->
            <h2 id="bayesian-basics">Bayesian Basics</h2>
            <p>
                At its core, Bayesian inference combines prior beliefs with observed data to form posterior beliefs.
                For a parameter Œ∏ given data y:
            </p>
            <div class="math-block">
                $$p(\theta | y) = \frac{p(y | \theta) \cdot p(\theta)}{p(y)} \propto p(y | \theta) \cdot p(\theta)$$
            </div>
            <p>Where:</p>
            <ul>
                <li><strong>p(Œ∏)</strong> ‚Äî Prior: what we believe before seeing data</li>
                <li><strong>p(y|Œ∏)</strong> ‚Äî Likelihood: probability of data given parameters</li>
                <li><strong>p(Œ∏|y)</strong> ‚Äî Posterior: updated beliefs after seeing data</li>
            </ul>

            <div class="definition">
                <h4>Credible Intervals vs. Confidence Intervals</h4>
                <p>
                    A 95% credible interval means "there is a 95% probability the true parameter lies in this interval."
                    This is the intuitive interpretation people often incorrectly apply to confidence intervals.
                    Bayesian inference gives you what you actually want.
                </p>
            </div>

            <!-- Choosing a Model -->
            <h2 id="choosing-model">Choosing a Model</h2>
            <table>
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Use When</th>
                        <th>Complexity</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Standard</strong></td>
                        <td>Single outcome, direct media effects only</td>
                        <td>Low</td>
                    </tr>
                    <tr>
                        <td><strong>Nested</strong></td>
                        <td>You have funnel metrics (awareness, consideration)</td>
                        <td>Medium</td>
                    </tr>
                    <tr>
                        <td><strong>Multivariate</strong></td>
                        <td>Multiple products/categories with cross-effects</td>
                        <td>High</td>
                    </tr>
                    <tr>
                        <td><strong>Combined</strong></td>
                        <td>Multiple products AND funnel metrics</td>
                        <td>Very High</td>
                    </tr>
                </tbody>
            </table>

            <!-- Standard MMM -->
            <h2 id="standard">Standard MMM</h2>
            <p>
                The standard model captures direct effects from media channels to a single outcome variable.
                This is the workhorse model for most MMM applications.
            </p>

            <h3 id="standard-adstock">Adstock Transformation</h3>
            <p>
                Media effects don't end when the ad stops running. Adstock captures the carryover effect
                of advertising over time. We support two functional forms:
            </p>

            <h4>Geometric Adstock</h4>
            <div class="math-block">
                $$A_t = x_t + \alpha \cdot A_{t-1}$$
            </div>
            <p>
                Where Œ± ‚àà [0, 1) is the decay rate. Higher Œ± means longer-lasting effects.
                The half-life is: <code>h = -log(2) / log(Œ±)</code>
            </p>

            <h4>Weibull Adstock</h4>
            <div class="math-block">
                $$A_t = \sum_{l=0}^{L} w_l \cdot x_{t-l}, \quad w_l = \exp\left(-\left(\frac{l}{\lambda}\right)^k\right)$$
            </div>
            <p>
                The Weibull form is more flexible, allowing for delayed peak effects (k > 1) or immediate
                decay (k < 1). Œª controls the scale of decay.
            </p>

            <h3 id="standard-saturation">Saturation Functions</h3>
            <p>
                Media effects exhibit diminishing returns. We implement two saturation functions:
            </p>

            <h4>Logistic Saturation (Recommended)</h4>
            <div class="math-block">
                $$f(x) = \frac{L}{1 + e^{-k(x - x_0)}}$$
            </div>
            <p>
                Numerically stable and well-behaved. L is the maximum effect, k controls steepness,
                and x‚ÇÄ is the inflection point.
            </p>

            <h4>Hill Function</h4>
            <div class="math-block">
                $$f(x) = \frac{S \cdot x^n}{K^n + x^n}$$
            </div>
            <p>
                Classic pharmacological model. S is saturation level, K is half-saturation constant,
                n controls steepness. Can be numerically unstable for large n.
            </p>

            <h3 id="standard-priors">Prior Specification</h3>
            <p>
                Priors should encode your domain knowledge. Here are recommended defaults:
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Prior</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Media coefficients (Œ≤)</td>
                        <td>HalfNormal(œÉ=0.5)</td>
                        <td>Positive effects, regularized</td>
                    </tr>
                    <tr>
                        <td>Adstock decay (Œ±)</td>
                        <td>Beta(2, 2)</td>
                        <td>Centered at 0.5, avoids extremes</td>
                    </tr>
                    <tr>
                        <td>Saturation steepness (k)</td>
                        <td>Gamma(2, 1)</td>
                        <td>Positive, allows flexibility</td>
                    </tr>
                    <tr>
                        <td>Control coefficients</td>
                        <td>Normal(0, 1)</td>
                        <td>Can be positive or negative</td>
                    </tr>
                </tbody>
            </table>

            <!-- Nested Model -->
            <h2 id="nested">Nested Model</h2>
            <p>
                The nested model extends the standard MMM to capture indirect effects through
                intermediate variables (mediators) like brand awareness or consideration.
            </p>

            <div class="definition">
                <h4>Mediation Analysis</h4>
                <p>
                    A mediator sits on the causal path between treatment (media) and outcome (sales).
                    TV ‚Üí Awareness ‚Üí Sales. The nested model estimates both the direct effect
                    (TV ‚Üí Sales) and the indirect effect (TV ‚Üí Awareness ‚Üí Sales).
                </p>
            </div>

            <h3 id="nested-mediators">Mediator Types</h3>
            <p>
                We support several mediator specifications depending on your data availability:
            </p>
            <ul>
                <li><strong>Observed mediators:</strong> You have actual awareness/consideration data</li>
                <li><strong>Latent mediators:</strong> Brand state is inferred from response patterns</li>
                <li><strong>Partial mediators:</strong> Some direct effect remains after controlling for mediator</li>
            </ul>

            <h3 id="nested-identification">Identification Considerations</h3>
            <div class="warning">
                <h4>‚ö†Ô∏è Identification Challenges</h4>
                <p>
                    Nested models require careful attention to identification. Without exogenous variation
                    in the mediator, the direct and indirect effects may not be separately identifiable.
                    Strong priors or additional data (e.g., survey data) may be necessary.
                </p>
            </div>

            <!-- Multivariate Model -->
            <h2 id="multivariate">Multivariate Model</h2>
            <p>
                The multivariate model jointly estimates effects across multiple outcome variables
                (e.g., product categories), capturing cross-effects and correlated errors.
            </p>

            <h3 id="cross-effects">Cross-Effects</h3>
            <p>
                Media for one product can affect sales of another through halo effects (positive spillover)
                or cannibalization (negative spillover):
            </p>
            <div class="math-block">
                $$y_{k,t} = \sum_j \beta_{j,k} \cdot f(A_{j,t}) + \sum_{k' \neq k} \gamma_{k',k} \cdot y_{k',t} + \epsilon_{k,t}$$
            </div>

            <div class="use-case-grid">
                <div class="use-case-card good">
                    <h5>‚úÖ Halo Effect</h5>
                    <p>Brand advertising lifts sales across the product line. Œ≥ > 0.</p>
                </div>
                <div class="use-case-card bad">
                    <h5>‚ö†Ô∏è Cannibalization</h5>
                    <p>Promoting one product steals sales from another. Œ≥ < 0.</p>
                </div>
            </div>

            <h3 id="multivariate-correlation">Correlated Errors</h3>
            <p>
                Products in the same category often share unobserved drivers. We model this with
                a multivariate normal error structure:
            </p>
            <div class="math-block">
                $$\epsilon_t \sim \mathcal{N}(0, \Sigma)$$
            </div>
            <p>
                Where Œ£ is estimated from the data, capturing residual correlations not explained
                by the model's systematic components.
            </p>

            <!-- Variable Selection Section -->
            <h2 id="variable-selection">Variable Selection Methods</h2>
            <p class="lead">
                Bayesian variable selection provides principled approaches to handling uncertainty about
                which control variables should be included in your model.
            </p>

            <div class="warning">
                <h4>‚ö†Ô∏è Critical: Variable Classification Required</h4>
                <p>
                    Variable selection should <strong>only</strong> be applied to precision control variables‚Äî
                    variables that affect the outcome but do NOT affect treatment assignment (media spending).
                    <strong>Confounders</strong> (variables affecting both media and sales) must be EXCLUDED 
                    from selection and always included with standard priors. Shrinking a confounder toward 
                    zero does not remove confounding bias‚Äîit hides it while biasing your media effect estimates.
                </p>
            </div>

            <h3>When Variable Selection is Appropriate</h3>
            <p>
                Variable selection addresses uncertainty about which precision controls matter. Traditional
                approaches like stepwise regression or p-value hunting are forms of specification shopping
                that invalidate inference. Bayesian variable selection priors provide an alternative that:
            </p>
            <ul>
                <li>Quantifies uncertainty about each variable's relevance</li>
                <li>Provides adaptive shrinkage (small effects ‚Üí zero, large effects preserved)</li>
                <li>Maintains valid posterior inference</li>
                <li>Can be pre-specified based on domain knowledge</li>
            </ul>

            <table>
                <thead>
                    <tr>
                        <th>Variable Type</th>
                        <th>Examples</th>
                        <th>Selection?</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Precision Controls</strong></td>
                        <td>Weather, gas prices, minor holidays</td>
                        <td><span class="badge badge-success">‚úì OK</span></td>
                        <td>Affect outcome only</td>
                    </tr>
                    <tr>
                        <td><strong>Confounders</strong></td>
                        <td>Distribution/ACV, price, competitor media</td>
                        <td><span class="badge badge-danger">‚úó Never</span></td>
                        <td>Shrinking biases estimates</td>
                    </tr>
                    <tr>
                        <td><strong>Core Structure</strong></td>
                        <td>Trend, seasonality, intercept</td>
                        <td><span class="badge badge-danger">‚úó Never</span></td>
                        <td>Fundamental components</td>
                    </tr>
                    <tr>
                        <td><strong>Mediators</strong></td>
                        <td>Brand awareness (if on causal path)</td>
                        <td><span class="badge badge-danger">‚úó Never</span></td>
                        <td>Blocks true media effect</td>
                    </tr>
                </tbody>
            </table>

            <h3>Available Methods</h3>
            <div class="method-grid">
                <div class="method-card">
                    <h4>Regularized Horseshoe</h4>
                    <p class="use-for">Best for: Sparse signals (few relevant controls)</p>
                    <p>
                        Strong shrinkage of noise toward zero while preserving true signals.
                        The "regularized" version adds slab regularization to prevent
                        unrealistically large coefficients.
                    </p>
                </div>
                <div class="method-card">
                    <h4>Spike-and-Slab</h4>
                    <p class="use-for">Best for: Explicit inclusion probabilities</p>
                    <p>
                        Provides direct posterior inclusion probabilities for each variable.
                        Uses continuous relaxation for gradient-based sampling (NUTS).
                    </p>
                </div>
                <div class="method-card">
                    <h4>Bayesian LASSO</h4>
                    <p class="use-for">Best for: Many small effects</p>
                    <p>
                        L1-like shrinkage in a Bayesian framework. Better when expecting
                        many controls have small but nonzero effects rather than sparse signals.
                    </p>
                </div>
                <div class="method-card">
                    <h4>Finnish Horseshoe</h4>
                    <p class="use-for">Same as regularized horseshoe</p>
                    <p>
                        Mathematically equivalent to regularized horseshoe. The name
                        emphasizes the slab regularization from Piironen & Vehtari (2017).
                    </p>
                </div>
            </div>

            <h3 id="vs-horseshoe">Regularized Horseshoe Prior</h3>
            <p>
                The horseshoe prior (Carvalho et al., 2010) with regularization (Piironen & Vehtari, 2017)
                is our recommended default for variable selection. It provides strong shrinkage for
                noise variables while preserving signals.
            </p>

            <h4>Mathematical Specification</h4>
            <div class="math-block">
                $$\beta_j = z_j \cdot \tau \cdot \tilde{\lambda}_j$$
            </div>
            <p>Where:</p>
            <ul>
                <li><strong>z<sub>j</sub> ~ N(0, 1)</strong> ‚Äî Standardized coefficient</li>
                <li><strong>œÑ ~ Half-t<sub>ŒΩ<sub>g</sub></sub>(œÑ‚ÇÄ)</strong> ‚Äî Global shrinkage</li>
                <li><strong>Œª<sub>j</sub> ~ Half-t<sub>ŒΩ<sub>l</sub></sub>(1)</strong> ‚Äî Local shrinkage</li>
                <li><strong>ŒªÃÉ<sub>j</sub></strong> ‚Äî Regularized local shrinkage (see below)</li>
            </ul>

            <p>The regularization prevents coefficients from being unrealistically large:</p>
            <div class="math-block">
                $$\tilde{\lambda}_j = \frac{c \cdot \lambda_j}{\sqrt{c^2 + \tau^2 \lambda_j^2}}$$
            </div>
            <p>Where c¬≤ ~ Inv-Gamma(ŒΩ<sub>s</sub>/2, ŒΩ<sub>s</sub>s¬≤/2) controls the slab width.</p>

            <h4>Global Shrinkage Calibration</h4>
            <p>
                The global shrinkage œÑ controls overall sparsity. The recommended scale:
            </p>
            <div class="math-block">
                $$\tau_0 = \frac{D_0}{D - D_0} \cdot \frac{\sigma}{\sqrt{N}}$$
            </div>
            <p>
                Where D‚ÇÄ is the expected number of nonzero coefficients, D is the total number
                of selection variables, œÉ is the residual standard deviation, and N is sample size.
            </p>

            <h4>Shrinkage Factor Interpretation</h4>
            <p>
                The effective shrinkage for coefficient Œ≤<sub>j</sub> is:
            </p>
            <div class="math-block">
                $$\kappa_j = \frac{1}{1 + \tau^2 \lambda_j^2}$$
            </div>
            <ul>
                <li><strong>Œ∫<sub>j</sub> ‚âà 1</strong> ‚Äî Strong shrinkage (toward zero, effectively excluded)</li>
                <li><strong>Œ∫<sub>j</sub> ‚âà 0</strong> ‚Äî Weak shrinkage (coefficient preserved, effectively included)</li>
            </ul>
            <p>
                The <strong>effective number of nonzero coefficients</strong> is:
            </p>
            <div class="math-block">
                $$m_{\text{eff}} = \sum_{j=1}^{D} (1 - \kappa_j)$$
            </div>

            <h4>Implementation</h4>
            <pre><code><span class="keyword">from</span> mmm_framework.mmm_extensions <span class="keyword">import</span> (
    VariableSelectionConfigBuilder,
    sparse_controls,
)

<span class="comment"># Method 1: Factory function (simplest)</span>
config = sparse_controls(
    expected_nonzero=<span class="number">3</span>,
    <span class="string">"distribution"</span>, <span class="string">"price"</span>, <span class="string">"competitor_media"</span>,  <span class="comment"># Confounders to exclude</span>
)

<span class="comment"># Method 2: Builder with full control</span>
config = (VariableSelectionConfigBuilder()
    .regularized_horseshoe(expected_nonzero=<span class="number">3</span>)
    .with_slab_scale(<span class="number">2.0</span>)  <span class="comment"># Max effect in std units</span>
    .with_slab_df(<span class="number">4.0</span>)     <span class="comment"># Slab tail weight</span>
    .exclude_confounders(<span class="string">"distribution"</span>, <span class="string">"price"</span>)
    .build())</code></pre>

            <h3 id="vs-spike-slab">Spike-and-Slab Prior</h3>
            <p>
                The spike-and-slab prior provides explicit posterior inclusion probabilities
                for each variable. We use a continuous relaxation for compatibility with
                gradient-based samplers (NUTS).
            </p>

            <h4>Mathematical Specification</h4>
            <div class="math-block">
                $$\beta_j = \gamma_j \cdot \beta_{\text{slab},j} + (1 - \gamma_j) \cdot \beta_{\text{spike},j}$$
            </div>
            <p>Where:</p>
            <ul>
                <li><strong>Œ≥<sub>j</sub> = sigmoid(logit<sub>Œ≥<sub>j</sub></sub> / T)</strong> ‚Äî Soft inclusion indicator</li>
                <li><strong>logit<sub>Œ≥<sub>j</sub></sub> ~ N(logit(œÄ), 1)</strong> ‚Äî Prior inclusion probability œÄ</li>
                <li><strong>Œ≤<sub>slab,j</sub> ~ N(0, œÉ<sub>slab</sub>)</strong> ‚Äî Diffuse "included" distribution</li>
                <li><strong>Œ≤<sub>spike,j</sub> ~ N(0, œÉ<sub>spike</sub>)</strong> ‚Äî Concentrated "excluded" distribution</li>
                <li><strong>T</strong> ‚Äî Temperature (lower = sharper selection)</li>
            </ul>

            <div class="note">
                <h4>üí° Interpreting Inclusion Probabilities</h4>
                <p>
                    Unlike the horseshoe's shrinkage factors, spike-and-slab directly outputs
                    Œ≥<sub>j</sub> which can be interpreted as "the posterior probability that
                    variable j has a non-zero effect." This makes reporting more intuitive.
                </p>
            </div>

            <h4>Implementation</h4>
            <pre><code><span class="keyword">from</span> mmm_framework.mmm_extensions <span class="keyword">import</span> (
    VariableSelectionConfigBuilder,
    selection_with_inclusion_probs,
)

<span class="comment"># Factory function</span>
config = selection_with_inclusion_probs(
    prior_inclusion=<span class="number">0.3</span>,  <span class="comment"># 30% prior prob of inclusion</span>
    <span class="string">"distribution"</span>, <span class="string">"price"</span>,  <span class="comment"># Confounders</span>
)

<span class="comment"># Builder approach</span>
config = (VariableSelectionConfigBuilder()
    .spike_slab(prior_inclusion=<span class="number">0.3</span>)
    .with_sharp_selection()  <span class="comment"># Lower temperature</span>
    .exclude_confounders(<span class="string">"distribution"</span>, <span class="string">"price"</span>)
    .build())</code></pre>

            <h3 id="vs-lasso">Bayesian LASSO</h3>
            <p>
                The Bayesian LASSO (Park & Casella, 2008) provides L1-like shrinkage in a
                Bayesian framework. It's better suited when expecting many controls have
                small but nonzero effects, rather than truly sparse signals.
            </p>

            <h4>Mathematical Specification</h4>
            <div class="math-block">
                $$\beta_j | \sigma^2, \lambda^2 \sim \mathcal{N}(0, \sigma^2 \tau_j^2)$$
                $$\tau_j^2 \sim \text{Exponential}\left(\frac{\lambda^2}{2}\right)$$
            </div>
            <p>
                The double-exponential (Laplace) marginal prior on Œ≤ produces L1-like
                shrinkage while maintaining a proper Bayesian posterior.
            </p>

            <h4>Implementation</h4>
            <pre><code><span class="keyword">from</span> mmm_framework.mmm_extensions <span class="keyword">import</span> (
    VariableSelectionConfigBuilder,
    dense_controls,
)

<span class="comment"># Factory function</span>
config = dense_controls(
    regularization=<span class="number">1.0</span>,
    <span class="string">"distribution"</span>, <span class="string">"price"</span>,
)

<span class="comment"># Builder approach</span>
config = (VariableSelectionConfigBuilder()
    .bayesian_lasso(regularization=<span class="number">1.0</span>)
    .exclude_confounders(<span class="string">"distribution"</span>, <span class="string">"price"</span>)
    .build())</code></pre>

            <h3 id="vs-interpretation">Interpreting Results</h3>
            <p>
                After fitting a model with variable selection, use the provided utilities
                to summarize which variables were selected and with what confidence:
            </p>

            <pre><code><span class="keyword">from</span> mmm_framework.mmm_extensions <span class="keyword">import</span> (
    compute_inclusion_probabilities,
    summarize_variable_selection,
)

<span class="comment"># Get inclusion probabilities</span>
inclusion = compute_inclusion_probabilities(
    trace=idata,
    config=selection_config,
    name=<span class="string">"ctrl_select"</span>,
)
<span class="keyword">print</span>(<span class="string">f"Effective nonzero: </span>{inclusion[<span class="string">'effective_nonzero'</span>]:<span class="string">.2f}</span><span class="string">"</span>)

<span class="comment"># Full summary table</span>
summary = summarize_variable_selection(
    trace=idata,
    control_names=precision_controls,
    config=selection_config,
    name=<span class="string">"ctrl_select"</span>,
)
<span class="keyword">print</span>(summary)
<span class="comment">#    variable      mean    std   hdi_3%  hdi_97%  inclusion_prob  selected
# 0   weather     0.15   0.08     0.01     0.28           0.89      True
# 1  gas_price    0.02   0.05    -0.06     0.10           0.23     False
# 2   holiday    -0.11   0.06    -0.21    -0.02           0.85      True</span></code></pre>

            <div class="caution">
                <h4>‚ö†Ô∏è Don't Overinterpret Low Inclusion Probabilities</h4>
                <p>
                    A low posterior inclusion probability doesn't prove a variable has no effect‚Äî
                    it means the data don't provide strong evidence for an effect. With more data
                    or a different prior, the conclusion might change. Report probabilities, not
                    binary decisions.
                </p>
            </div>

            <h4>Best Practices</h4>
            <ul>
                <li><strong>Pre-specify variable classification</strong> before seeing any results</li>
                <li><strong>Document rationale</strong> for each variable's classification</li>
                <li><strong>Never tune hyperparameters</strong> based on fit metrics (this is specification shopping)</li>
                <li><strong>Report inclusion probabilities</strong> alongside point estimates</li>
                <li><strong>Show sensitivity</strong> to expected_nonzero specification</li>
                <li><strong>Acknowledge uncertainty</strong> about variable importance</li>
            </ul>

            <!-- Advanced Topics -->
            <h2 id="combined">Combined Model</h2>
            <p>
                The combined model incorporates both nested (mediation) and multivariate (cross-effects)
                components. This is the most complex specification and should only be used when
                data richness supports it.
            </p>

            <h2 id="hierarchical">Hierarchical Structure</h2>
            <p>
                For data with natural groupings (regions, stores, products), hierarchical priors
                allow partial pooling of information:
            </p>
            <div class="math-block">
                $$\beta_g \sim \mathcal{N}(\mu_\beta, \sigma_\beta)$$
            </div>
            <p>
                This provides regularization (extreme groups shrink toward the mean) while still
                allowing group-specific estimates.
            </p>

            <h2 id="diagnostics">Model Diagnostics</h2>
            <p>
                Always check model diagnostics before interpreting results:
            </p>
            <ul>
                <li><strong>R-hat < 1.01:</strong> Chains have converged</li>
                <li><strong>Effective sample size:</strong> ESS > 400 per chain</li>
                <li><strong>Divergences:</strong> Should be zero or near-zero</li>
                <li><strong>Posterior predictive checks:</strong> Model captures data patterns</li>
                <li><strong>Prior sensitivity:</strong> Results robust to reasonable prior changes</li>
            </ul>

            <div class="note">
                <h4>üí° When Diagnostics Fail</h4>
                <p>
                    Poor diagnostics often indicate model misspecification or identification problems,
                    not just sampling issues. Consider: Is the model too complex for the data?
                    Are priors too vague? Are there collinear predictors?
                </p>
            </div>
        </main>
    </div>

    <script>
        // Initialize KaTeX
        document.addEventListener('DOMContentLoaded', () => {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });
        });

        // Highlight current section in sidebar
        const sections = document.querySelectorAll('h2[id], h3[id]');
        const navLinks = document.querySelectorAll('.sidebar-nav a');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>