<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Guide | MMM Framework</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --color-primary: #8fa86a;
            --color-primary-dark: #6d8a4a;
            --color-accent: #6a8fa8;
            --color-accent-dark: #4a6d8a;
            --color-bg: #fafbf9;
            --color-bg-alt: #f0f2ed;
            --color-surface: #ffffff;
            --color-text: #2d3a2d;
            --color-text-muted: #5a6b5a;
            --color-border: #d4ddd4;
            --color-success: #6abf8a;
            --color-warning: #d4a86a;
            --color-danger: #c97067;
            --shadow-sm: 0 2px 8px rgba(45, 58, 45, 0.06);
            --shadow-md: 0 8px 24px rgba(45, 58, 45, 0.08);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.8;
            font-size: 17px;
        }

        nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(250, 251, 249, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 0;
        }
        .nav-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'DM Serif Display', serif; font-size: 1.5rem; color: var(--color-primary-dark); text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-links a { color: var(--color-text-muted); text-decoration: none; font-weight: 500; transition: var(--transition-smooth); }
        .nav-links a:hover, .nav-links a.active { color: var(--color-primary); }

        .page-layout { display: grid; grid-template-columns: 280px 1fr; max-width: 1400px; margin: 0 auto; padding-top: 5rem; }
        
        .sidebar {
            position: sticky; top: 5rem; height: calc(100vh - 5rem);
            overflow-y: auto; padding: 2rem; border-right: 1px solid var(--color-border); background: var(--color-bg);
        }
        .sidebar h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--color-text-muted); margin-bottom: 1rem; margin-top: 1.5rem; }
        .sidebar h3:first-child { margin-top: 0; }
        .sidebar-nav { list-style: none; }
        .sidebar-nav a { display: block; padding: 0.5rem 0; color: var(--color-text-muted); text-decoration: none; font-size: 0.95rem; transition: var(--transition-smooth); border-left: 2px solid transparent; padding-left: 1rem; margin-left: -1rem; }
        .sidebar-nav a:hover, .sidebar-nav a.active { color: var(--color-primary); border-left-color: var(--color-primary); }
        .sidebar-nav .sub-item a { padding-left: 2rem; font-size: 0.9rem; }

        .main-content { padding: 3rem 4rem; max-width: 900px; }
        .main-content h1 { font-family: 'DM Serif Display', serif; font-size: 2.5rem; margin-bottom: 1rem; color: var(--color-text); }
        .main-content h2 { font-family: 'DM Serif Display', serif; font-size: 1.8rem; margin-top: 3rem; margin-bottom: 1rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); color: var(--color-text); }
        .main-content h2:first-of-type { border-top: none; margin-top: 2rem; }
        .main-content h3 { font-size: 1.3rem; margin-top: 2rem; margin-bottom: 0.75rem; color: var(--color-text); }
        .main-content h4 { font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--color-text-muted); }
        .lead { font-size: 1.15rem; color: var(--color-text-muted); margin-bottom: 2rem; }
        p { margin-bottom: 1rem; }

        .math-block { background: var(--color-bg-alt); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; overflow-x: auto; position: relative; }
        .equation-label { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 0.9rem; }

        pre { background: var(--color-bg-alt); padding: 1.5rem; border-radius: 8px; overflow-x: auto; margin: 1.5rem 0; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }
        p code, li code { background: var(--color-bg-alt); padding: 0.2rem 0.5rem; border-radius: 4px; }

        table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; background: var(--color-surface); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-sm); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--color-border); }
        th { background: var(--color-bg-alt); font-weight: 600; }
        tbody tr:last-child td { border-bottom: none; }

        .definition { background: rgba(106, 143, 168, 0.1); border-left: 4px solid var(--color-accent); padding: 1.5rem; border-radius: 0 8px 8px 0; margin: 1.5rem 0; }
        .definition h4 { color: var(--color-accent-dark); margin-top: 0; margin-bottom: 0.5rem; }
        .warning { background: rgba(201, 112, 103, 0.1); border-left: 4px solid var(--color-danger); padding: 1.5rem; border-radius: 0 8px 8px 0; margin: 1.5rem 0; }
        .warning h4 { color: var(--color-danger); margin-top: 0; margin-bottom: 0.5rem; }
        .note { background: rgba(143, 168, 106, 0.1); border-left: 4px solid var(--color-primary); padding: 1.5rem; border-radius: 0 8px 8px 0; margin: 1.5rem 0; }
        .note h4 { color: var(--color-primary-dark); margin-top: 0; margin-bottom: 0.5rem; }

        .model-diagram { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 2rem; margin: 2rem 0; }
        .dag-box { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; }
        .dag-box .mermaid { background: transparent; margin: 0; padding: 0; }
        .dag-box .mermaid svg { max-width: 100%; height: auto; }

        ul, ol { margin: 1rem 0 1rem 1.5rem; }
        li { margin-bottom: 0.5rem; }

        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
        .method-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; }
        .method-card h4 { margin-top: 0; margin-bottom: 0.5rem; color: var(--color-primary-dark); }
        .method-card .use-for { font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 1rem; }

        @media (max-width: 1024px) {
            .page-layout { grid-template-columns: 1fr; }
            .sidebar { position: relative; top: auto; height: auto; border-right: none; border-bottom: 1px solid var(--color-border); }
            .main-content { padding: 2rem; }
            .two-col { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <a href="index.html" class="logo">MMM Framework</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="variable-selection.html">Variable Selection</a></li>
                <li><a href="#" class="active">Technical Guide</a></li>
                <li><a href="https://github.com/redam94/mmm-framework" target="_blank">GitHub</a></li>
            </ul>
        </div>
    </nav>

    <div class="page-layout">
        <aside class="sidebar">
            <h3>Getting Started</h3>
            <ul class="sidebar-nav">
                <li><a href="#overview">Overview</a></li>
                <li><a href="#bayesian-basics">Bayesian Basics</a></li>
                <li><a href="#choosing-model">Choosing a Model</a></li>
            </ul>

            <h3>Standard MMM</h3>
            <ul class="sidebar-nav">
                <li><a href="#standard">Model Structure</a></li>
                <li><a href="#standard-adstock">Adstock Transformation</a></li>
                <li><a href="#standard-saturation">Saturation Functions</a></li>
                <li><a href="#standard-trend">Trend & Seasonality</a></li>
                <li><a href="#standard-priors">Prior Specification</a></li>
            </ul>

            <h3>Nested Model</h3>
            <ul class="sidebar-nav">
                <li><a href="#nested">Model Structure</a></li>
                <li><a href="#nested-effects">Effect Decomposition</a></li>
                <li><a href="#nested-mediators">Mediator Types</a></li>
                <li><a href="#nested-identification">Identification</a></li>
            </ul>

            <h3>Multivariate Model</h3>
            <ul class="sidebar-nav">
                <li><a href="#multivariate">Model Structure</a></li>
                <li><a href="#cross-effects">Cross-Effects</a></li>
                <li><a href="#multivariate-correlation">Correlated Errors</a></li>
            </ul>

            <h3>Combined Model</h3>
            <ul class="sidebar-nav">
                <li><a href="#combined">Full Specification</a></li>
                <li><a href="#combined-dag">DAG Representation</a></li>
            </ul>

            <h3>Hierarchical Structure</h3>
            <ul class="sidebar-nav">
                <li><a href="#hierarchical">Partial Pooling</a></li>
                <li><a href="#hierarchical-geo">Geographic Effects</a></li>
                <li><a href="#hierarchical-param">Parameterization</a></li>
            </ul>

            <h3>Variable Selection</h3>
            <ul class="sidebar-nav">
                <li><a href="#variable-selection">Overview & Cautions</a></li>
                <li><a href="#vs-horseshoe">Regularized Horseshoe</a></li>
                <li><a href="#vs-spike-slab">Spike-and-Slab</a></li>
                <li><a href="#vs-lasso">Bayesian LASSO</a></li>
                <li><a href="#vs-interpretation">Interpretation</a></li>
            </ul>

            <h3>Diagnostics</h3>
            <ul class="sidebar-nav">
                <li><a href="#diagnostics">Convergence</a></li>
                <li><a href="#diagnostics-ident">Identifiability</a></li>
                <li><a href="#diagnostics-comparison">Model Comparison</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <h1>Technical Guide</h1>
            <p class="lead">
                A comprehensive reference for data scientists implementing Bayesian Marketing Mix Models.
                This guide covers mathematical foundations, model specifications, and practical considerations
                for each model type in the framework.
            </p>

            <h2 id="overview">Overview</h2>
            <p>
                Marketing Mix Modeling (MMM) estimates the incremental impact of marketing activities on business
                outcomes like sales or conversions. This framework implements MMM using Bayesian inference,
                which provides several advantages over traditional frequentist approaches:
            </p>
            <ul>
                <li><strong>Uncertainty quantification:</strong> Full posterior distributions, not just point estimates</li>
                <li><strong>Prior incorporation:</strong> Domain knowledge can be encoded in priors</li>
                <li><strong>Regularization:</strong> Priors act as natural regularizers, preventing overfitting</li>
                <li><strong>Hierarchical modeling:</strong> Partial pooling across geographies and products</li>
                <li><strong>Decision-ready outputs:</strong> Credible intervals directly answer "how confident are we?"</li>
            </ul>

            <h2 id="bayesian-basics">Bayesian Basics</h2>
            <p>
                At its core, Bayesian inference combines prior beliefs with observed data to form posterior beliefs.
                For a parameter Œ∏ given data y:
            </p>
            <div class="math-block">
                $$p(\theta | y) = \frac{p(y | \theta) \cdot p(\theta)}{p(y)} \propto p(y | \theta) \cdot p(\theta)$$
            </div>
            <p>Where:</p>
            <ul>
                <li><strong>p(Œ∏)</strong> ‚Äî Prior: what we believe before seeing data</li>
                <li><strong>p(y|Œ∏)</strong> ‚Äî Likelihood: probability of data given parameters</li>
                <li><strong>p(Œ∏|y)</strong> ‚Äî Posterior: updated beliefs after seeing data</li>
            </ul>

            <div class="definition">
                <h4>Credible Intervals vs. Confidence Intervals</h4>
                <p>
                    A 94% Bayesian credible interval means "there is a 94% probability the true parameter lies
                    in this range, given our prior and data." This is a direct probability statement about the
                    parameter‚Äîunlike frequentist confidence intervals, which are statements about the procedure.
                </p>
            </div>

            <h3>Positivity Constraints via Priors</h3>
            <p>
                Media coefficients should generally be positive (advertising shouldn't decrease sales). Rather than
                post-hoc filtering (which invalidates inference), we encode this through priors that
                concentrate probability mass on positive values:
            </p>
            <div class="math-block">
                $$\beta \sim \text{HalfNormal}(\sigma = 0.5)$$
            </div>

            <div class="warning">
                <h4>‚ö†Ô∏è Specification Shopping</h4>
                <p>
                    Running multiple models and selecting one with "reasonable" coefficients is specification
                    shopping. This practice destroys the statistical properties of your estimates. Instead,
                    encode constraints through priors <em>before</em> seeing the data, then report
                    the single resulting posterior.
                </p>
            </div>

            <h2 id="choosing-model">Choosing a Model</h2>
            
            <table>
                <thead>
                    <tr><th>Model</th><th>Use When</th><th>Complexity</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Standard MMM</strong></td>
                        <td>Single outcome, no intermediate metrics, simple attribution</td>
                        <td>Low</td>
                    </tr>
                    <tr>
                        <td><strong>Nested MMM</strong></td>
                        <td>Upper-funnel metrics available (awareness, consideration), want direct/indirect decomposition</td>
                        <td>Medium</td>
                    </tr>
                    <tr>
                        <td><strong>Multivariate MMM</strong></td>
                        <td>Multiple outcomes that may interact (product portfolio, cannibalization)</td>
                        <td>Medium</td>
                    </tr>
                    <tr>
                        <td><strong>Combined MMM</strong></td>
                        <td>Both mediators AND multiple interacting outcomes</td>
                        <td>High</td>
                    </tr>
                </tbody>
            </table>

            <h3>Data Structure Considerations</h3>
            <table>
                <thead>
                    <tr><th>Data Structure</th><th>Recommended Model</th></tr>
                </thead>
                <tbody>
                    <tr><td>National aggregate only</td><td>Single time-series model; acknowledge wide uncertainty</td></tr>
                    <tr><td>Multiple geographies, national media</td><td>Hierarchical model with random intercepts by geo</td></tr>
                    <tr><td>Multiple geographies, regional media variation</td><td>Hierarchical model with random slopes on media</td></tr>
                    <tr><td>Many geographies, rich regional variation</td><td>Full hierarchical model with geo-level covariates</td></tr>
                </tbody>
            </table>

            <h2 id="standard">Standard MMM</h2>
            <p>
                The standard model relates marketing inputs to a single outcome through transformed 
                media variables. Channel contributions flow through three sequential components: 
                adstock (carryover), saturation (diminishing returns), and coefficient scaling.
            </p>

            <div class="model-diagram">
                <svg viewBox="0 0 600 100" width="100%">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#5a6b5a"/>
                        </marker>
                    </defs>
                    <rect x="10" y="30" width="80" height="40" rx="8" fill="#8fa86a" opacity="0.8"/>
                    <text x="50" y="55" text-anchor="middle" fill="white" font-size="11" font-weight="600">Media Spend</text>
                    <rect x="130" y="25" width="90" height="50" rx="8" fill="#e5e8e0" stroke="#d4ddd4" stroke-width="2"/>
                    <text x="175" y="47" text-anchor="middle" fill="#5a6b5a" font-size="10" font-weight="600">Adstock</text>
                    <text x="175" y="62" text-anchor="middle" fill="#5a6b5a" font-size="9">g(x)</text>
                    <rect x="260" y="25" width="90" height="50" rx="8" fill="#e5e8e0" stroke="#d4ddd4" stroke-width="2"/>
                    <text x="305" y="47" text-anchor="middle" fill="#5a6b5a" font-size="10" font-weight="600">Saturation</text>
                    <text x="305" y="62" text-anchor="middle" fill="#5a6b5a" font-size="9">f(¬∑)</text>
                    <rect x="390" y="30" width="60" height="40" rx="8" fill="#6a8fa8" opacity="0.8"/>
                    <text x="420" y="55" text-anchor="middle" fill="white" font-size="12" font-weight="600">Œ≤</text>
                    <rect x="490" y="30" width="80" height="40" rx="8" fill="#d4a86a" opacity="0.8"/>
                    <text x="530" y="55" text-anchor="middle" fill="white" font-size="11" font-weight="600">Sales</text>
                    <path d="M 95 50 L 125 50" stroke="#5a6b5a" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <path d="M 225 50 L 255 50" stroke="#5a6b5a" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <path d="M 355 50 L 385 50" stroke="#5a6b5a" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <path d="M 455 50 L 485 50" stroke="#5a6b5a" stroke-width="2" marker-end="url(#arrowhead)"/>
                </svg>
            </div>

            <h3>Full Model Specification</h3>
            <p>The complete generative model for the standard MMM is:</p>
            <div class="math-block">
                <span class="equation-label">(1)</span>
                $$y_t = \alpha + \underbrace{\sum_{m=1}^{M} \beta_m \cdot f_{\text{sat}}\left(g_{\text{adstock}}(x_{m,t})\right)}_{\text{Media Effects}} + \underbrace{\tau(t)}_{\text{Trend}} + \underbrace{s(t)}_{\text{Seasonality}} + \underbrace{\gamma' \mathbf{z}_t}_{\text{Controls}} + \epsilon_t$$
            </div>
            <p>Where:</p>
            <ul>
                <li>$y_t$ is the outcome at time $t$ (optionally log-transformed)</li>
                <li>$x_{m,t}$ is spend for media channel $m$ at time $t$</li>
                <li>$g_{\text{adstock}}(\cdot)$ is the adstock transformation (carryover)</li>
                <li>$f_{\text{sat}}(\cdot)$ is the saturation function (diminishing returns)</li>
                <li>$\tau(t)$ is the trend component</li>
                <li>$s(t)$ is the seasonality component</li>
                <li>$\mathbf{z}_t$ is a vector of control variables</li>
                <li>$\epsilon_t \sim \mathcal{N}(0, \sigma^2)$ is the error term</li>
            </ul>

            <h4>Multiplicative (Log-Log) Specification</h4>
            <p>For elasticity interpretation, use the multiplicative form:</p>
            <div class="math-block">
                $$\log(y_t) = \log(\beta_0) + \sum_{m=1}^{M} \beta_m \log\left(f_m(x_{m,t})\right) + \gamma' \mathbf{z}_t + \epsilon_t$$
            </div>
            <p>Coefficients now represent <strong>elasticities</strong>: percent change in sales per percent change in media.</p>

            <h3 id="standard-adstock">Adstock Transformation</h3>
            <p>
                Adstock captures carryover effects‚Äîthe idea that today's advertising continues to 
                influence sales in future periods.
            </p>

            <div class="definition">
                <h4>Geometric Adstock (Default)</h4>
                <p>The simplest form with a single decay parameter $\alpha \in [0, 1)$:</p>
            </div>
            <div class="math-block">
                <span class="equation-label">(2)</span>
                $$A_t = x_t + \alpha \cdot A_{t-1} = \sum_{l=0}^{L} \alpha^l \cdot x_{t-l}$$
            </div>
            <p>The <strong>half-life</strong> (time for effect to decay by 50%) is:</p>
            <div class="math-block">
                $$t_{1/2} = \frac{\log(0.5)}{\log(\alpha)} = \frac{-0.693}{\log(\alpha)}$$
            </div>
            <p>For $\alpha = 0.7$: half-life ‚âà 1.9 periods. For $\alpha = 0.9$: half-life ‚âà 6.6 periods.</p>

            <h4>Weibull/Delayed Adstock</h4>
            <p>For channels where peak effect is delayed:</p>
            <div class="math-block">
                <span class="equation-label">(3)</span>
                $$w_l = \exp\left(-\left(\frac{l}{\theta}\right)^k\right) - \exp\left(-\left(\frac{l+1}{\theta}\right)^k\right)$$
            </div>

            <pre><code># Adstock configuration
adstock = (AdstockConfigBuilder()
    .geometric()
    .with_max_lag(8)
    .with_alpha_prior(PriorConfig.beta(alpha=1, beta=3))
    .build())</code></pre>

            <h3 id="standard-saturation">Saturation Functions</h3>
            <p>Saturation captures diminishing returns‚Äîeach additional dollar produces less incremental effect.</p>

            <div class="definition">
                <h4>Logistic Saturation (Recommended)</h4>
            </div>
            <div class="math-block">
                <span class="equation-label">(4)</span>
                $$f_{\text{logistic}}(x) = 1 - \exp(-\lambda x)$$
            </div>

            <h4>Hill Function</h4>
            <div class="math-block">
                <span class="equation-label">(5)</span>
                $$f_{\text{Hill}}(x) = \frac{x^S}{K^S + x^S}$$
            </div>
            <p>Where <strong>K</strong> is the half-saturation point and <strong>S</strong> is slope.</p>

            <div class="warning">
                <h4>‚ö†Ô∏è Identification Warning</h4>
                <p>
                    Hill function parameters can be weakly identified. <strong>Constrain K's prior to the observed data range.</strong>
                </p>
            </div>

            <h3 id="standard-trend">Trend & Seasonality</h3>
            
            <table>
                <thead><tr><th>Type</th><th>Description</th><th>Use When</th></tr></thead>
                <tbody>
                    <tr><td><strong>Linear</strong></td><td>$\tau(t) = \delta \cdot t$</td><td>Stable growth/decline</td></tr>
                    <tr><td><strong>Piecewise</strong></td><td>Linear segments with changepoints</td><td>Known structural breaks</td></tr>
                    <tr><td><strong>B-Spline</strong></td><td>Smooth nonlinear trend</td><td>Flexible trend</td></tr>
                    <tr><td><strong>Gaussian Process</strong></td><td>$\tau(t) \sim \mathcal{GP}(0, k(t, t'))$</td><td>Maximum flexibility</td></tr>
                </tbody>
            </table>

            <h4>Fourier Seasonality</h4>
            <div class="math-block">
                <span class="equation-label">(6)</span>
                $$s(t) = \sum_{n=1}^{N} \left[ a_n \sin\left(\frac{2\pi n t}{P}\right) + b_n \cos\left(\frac{2\pi n t}{P}\right) \right]$$
            </div>

            <div class="note">
                <h4>üí° Why Explicit Trend & Seasonality Matter</h4>
                <p>
                    You might wonder: "If my control variables (e.g., temperature, holidays) already capture seasonal patterns, 
                    why include explicit seasonality components?" The answer lies in how media spending correlates with time.
                </p>
                <p>
                    <strong>The problem:</strong> Advertisers typically increase spend during high-demand periods (Q4 holidays, 
                    summer travel season). This means media spend is correlated with seasonality. If you rely on control 
                    variables to absorb seasonal patterns, any correlation between those controls and media will bias your 
                    media effect estimates.
                </p>
                <p>
                    <strong>The solution:</strong> Explicit trend and seasonality components isolate the structural time 
                    patterns that exist <em>regardless of marketing activity</em>. This allows the model to:
                </p>
                <ul style="margin-top: 0.5rem; margin-bottom: 0;">
                    <li>Separate "sales are high because it's December" from "sales are high because we spent on TV"</li>
                    <li>Prevent media from getting credit for seasonal uplift it didn't cause</li>
                    <li>Allow controls to capture their specific effects without also serving as proxies for time</li>
                    <li>Provide cleaner counterfactual estimation (what would sales be with zero media?)</li>
                </ul>
                <p style="margin-top: 1rem; margin-bottom: 0;">
                    <strong>Rule of thumb:</strong> Always include trend and seasonality components. Let controls capture 
                    their incremental effects <em>beyond</em> structural time patterns, not instead of them.
                </p>
            </div>

            <h3 id="standard-priors">Prior Specification</h3>
            <pre><code># Recommended default priors for standardized data
beta_media ~ HalfNormal(sigma=0.5)      # Media coefficients
alpha ~ Beta(alpha=1, beta=3)            # Adstock decay
kappa ~ Beta(alpha=2, beta=2)            # Hill half-saturation
slope ~ HalfNormal(sigma=1.5)            # Hill slope
lambda_sat ~ Gamma(alpha=2, beta=1)      # Logistic saturation rate
intercept ~ Normal(mu=0, sigma=1)        # Intercept
gamma ~ Normal(mu=0, sigma=0.5)          # Control coefficients
sigma ~ HalfNormal(sigma=0.5)            # Noise
delta ~ Normal(mu=0, sigma=0.1)          # Trend growth
season_coef ~ Normal(mu=0, sigma=0.3)    # Seasonality</code></pre>

            <h2 id="nested">Nested Model</h2>
            <p>
                Nested models estimate causal pathways where media affects intermediate outcomes 
                (mediators) which in turn affect the final outcome.
            </p>

            <h3>Core Structure</h3>
            <div class="definition"><h4>Stage 1 ‚Äî Media ‚Üí Mediator</h4></div>
            <div class="math-block">
                <span class="equation-label">(7)</span>
                $$M_t = \alpha_M + \sum_{c=1}^{C} \beta^{(M)}_c \cdot f_c(x_{c,t}) + \epsilon^{(M)}_t$$
            </div>

            <div class="definition"><h4>Stage 2 ‚Äî Mediator ‚Üí Outcome</h4></div>
            <div class="math-block">
                <span class="equation-label">(8)</span>
                $$y_t = \alpha_y + \gamma \cdot M_t + \sum_{c=1}^{C} \beta^{(D)}_c \cdot f_c(x_{c,t}) + \epsilon^{(y)}_t$$
            </div>

            <h3 id="nested-effects">Effect Decomposition</h3>
            <div class="math-block">
                <span class="equation-label">(9)</span>
                $$\text{Total Effect}_c = \underbrace{\beta^{(D)}_c}_{\text{Direct}} + \underbrace{\beta^{(M)}_c \cdot \gamma}_{\text{Indirect}}$$
            </div>
            <div class="math-block">
                $$\text{Proportion Mediated}_c = \frac{\beta^{(M)}_c \cdot \gamma}{\beta^{(D)}_c + \beta^{(M)}_c \cdot \gamma}$$
            </div>

            <h3 id="nested-mediators">Mediator Types</h3>
            <table>
                <thead><tr><th>Type</th><th>Data Requirement</th><th>Observation Model</th></tr></thead>
                <tbody>
                    <tr><td><strong>Fully Observed</strong></td><td>Complete time series</td><td>$M^{obs}_t = M_t + \nu_t$</td></tr>
                    <tr><td><strong>Partially Observed</strong></td><td>Sparse survey data</td><td>$M^{obs}_{t_i} = M_{t_i} + \nu_{t_i}$ for observed periods</td></tr>
                    <tr><td><strong>Fully Latent</strong></td><td>No direct observations</td><td>Inferred from outcome; requires strong priors</td></tr>
                </tbody>
            </table>

            <h3 id="nested-identification">Identification Considerations</h3>
            <table>
                <thead><tr><th>Model</th><th>Key Requirements</th></tr></thead>
                <tbody>
                    <tr><td>Nested (fully observed)</td><td>Variation in media, complete mediator data</td></tr>
                    <tr><td>Nested (partially observed)</td><td>Sufficient survey observations, informative priors</td></tr>
                    <tr><td>Nested (fully latent)</td><td>Strong priors, non-zero mediator effect assumed</td></tr>
                </tbody>
            </table>

            <h2 id="multivariate">Multivariate Model</h2>
            <p>
                The multivariate model jointly estimates effects on multiple outcomes, capturing 
                correlations and cross-effects between products.
            </p>

            <h3>Model Structure</h3>
            <div class="math-block">
                <span class="equation-label">(10)</span>
                $$y_{k,t} = \alpha_k + \sum_{c=1}^{C} \beta_{kc} \cdot f_c(x_{c,t}) + \sum_{j \neq k} \psi_{jk} \cdot y_{j,t} + \epsilon_{k,t}$$
            </div>

            <h3 id="cross-effects">Cross-Effects</h3>
            <div class="two-col">
                <div class="method-card">
                    <h4>Cannibalization (œà < 0)</h4>
                    <p class="use-for">Product j steals from product k</p>
                    <div class="math-block" style="padding: 1rem; margin: 0.5rem 0;">$$\psi_{jk} \sim \mathcal{N}^-(0, 0.3)$$</div>
                </div>
                <div class="method-card">
                    <h4>Halo Effect (œà > 0)</h4>
                    <p class="use-for">Product j lifts product k</p>
                    <div class="math-block" style="padding: 1rem; margin: 0.5rem 0;">$$\psi_{jk} \sim \mathcal{N}^+(0, 0.3)$$</div>
                </div>
            </div>

            <h4>Promotion-Modulated Cross-Effects</h4>
            <div class="math-block">
                <span class="equation-label">(11)</span>
                $$y_{k,t} = \ldots + \psi_{jk} \cdot P_{j,t} \cdot y_{j,t} + \ldots$$
            </div>

            <h3 id="multivariate-correlation">Correlated Errors</h3>
            <div class="math-block">
                <span class="equation-label">(12)</span>
                $$\boldsymbol{\epsilon}_t \sim \mathcal{N}(\mathbf{0}, \boldsymbol{\Sigma}), \quad \boldsymbol{\Sigma} = \text{diag}(\boldsymbol{\sigma}) \cdot \mathbf{R} \cdot \text{diag}(\boldsymbol{\sigma}), \quad \mathbf{R} \sim \text{LKJ}(\eta)$$
            </div>

            <h2 id="combined">Combined Model</h2>
            <p>The combined model integrates nested pathways and multivariate outcomes.</p>

            <h3 id="combined-dag">Full Specification</h3>
            <p><strong>Mediator equations:</strong></p>
            <div class="math-block">
                <span class="equation-label">(13)</span>
                $$M_{m,t} = \alpha_m + \sum_{c \in \mathcal{C}_m} \beta^{(M)}_{mc} \cdot f_c(x_{c,t}) + \epsilon^{(M)}_{m,t}$$
            </div>
            <p><strong>Outcome equations:</strong></p>
            <div class="math-block">
                <span class="equation-label">(14)</span>
                $$y_{k,t} = \alpha_k + \underbrace{\sum_{c=1}^{C} \beta^{(D)}_{kc} \cdot f_c(x_{c,t})}_{\text{Direct}} + \underbrace{\sum_{m \in \mathcal{M}_k} \gamma_{km} \cdot M_{m,t}}_{\text{Mediator}} + \underbrace{\sum_{j \neq k} \psi_{jk} \cdot y_{j,t}}_{\text{Cross-effects}} + \epsilon_{k,t}$$
            </div>

            <h3>DAG Representation</h3>
            <div class="dag-box" style="display: flex; justify-content: center;">
                <pre class="mermaid">
flowchart TB
    Media["üéØ Media Channels"]
    
    M1["Mediator 1<br/>Awareness"]
    M2["Mediator 2<br/>Consideration"]
    Direct["Direct Effects"]
    
    Y1["Y‚ÇÅ Product A"]
    Y2["Y‚ÇÇ Product B"]
    
    Sigma["Correlated Errors Œ£"]
    
    Media --> M1
    Media --> M2
    Media --> Direct
    
    M1 --> Y1
    M1 --> Y2
    M2 --> Y1
    M2 --> Y2
    Direct --> Y1
    Direct --> Y2
    
    Y1 <-.->|"Cross-effects œà"| Y2
    
    Y1 -.-> Sigma
    Y2 -.-> Sigma
    
    style Media fill:#8fa86a,stroke:#6d8a4a,color:#fff
    style M1 fill:#6a8fa8,stroke:#4a6d8a,color:#fff
    style M2 fill:#6a8fa8,stroke:#4a6d8a,color:#fff
    style Direct fill:#e5e8e0,stroke:#c4cdc4,color:#5a6b5a
    style Y1 fill:#d4a86a,stroke:#b8860b,color:#fff
    style Y2 fill:#d4a86a,stroke:#b8860b,color:#fff
    style Sigma fill:#f5f7f3,stroke:#d4ddd4,color:#5a6b5a
                </pre>
            </div>

            <h2 id="hierarchical">Hierarchical Structure</h2>
            <p>
                Hierarchical models provide <strong>partial pooling</strong>‚Äîsharing information across groups while allowing heterogeneity.
            </p>

            <h3 id="hierarchical-geo">Geographic Hierarchy</h3>
            <div class="math-block">
                <span class="equation-label">(15)</span>
                $$\beta_g \sim \mathcal{N}(\bar{\beta}, \tau^2)$$
            </div>
            <div class="math-block">
                <span class="equation-label">(16)</span>
                $$y_{gt} = \alpha_g + \beta_g x_{gt} + \gamma' \mathbf{z}_{gt} + \epsilon_{gt}$$
            </div>

            <div class="warning">
                <h4>‚ö†Ô∏è National Media Limitation</h4>
                <p>
                    Geo-level random effects on <strong>national</strong> media coefficients cannot be
                    interpreted as differential causal response‚Äînational media provides no geo-level
                    exposure variation.
                </p>
            </div>

            <h3 id="hierarchical-param">Parameterization</h3>
            <div class="two-col">
                <div class="method-card">
                    <h4>Centered (Default)</h4>
                    <pre><code>beta_g ~ Normal(mu_beta, tau)</code></pre>
                    <p>Works well with sufficient data per group.</p>
                </div>
                <div class="method-card">
                    <h4>Non-Centered</h4>
                    <pre><code>offset_g ~ Normal(0, 1)
beta_g = mu_beta + tau * offset_g</code></pre>
                    <p>Use when groups have < 20 observations.</p>
                </div>
            </div>

            <h2 id="variable-selection">Variable Selection Methods</h2>
            
            <div class="warning">
                <h4>‚ö†Ô∏è Critical: Variable Classification Required</h4>
                <p>
                    Variable selection should <strong>only</strong> be applied to precision control variables.
                    <strong>Confounders</strong> must be EXCLUDED from selection. See <a href="variable-selection.html">Variable Selection page</a> for details.
                </p>
            </div>

            <h3 id="vs-horseshoe">Regularized Horseshoe Prior</h3>
            <div class="math-block">
                <span class="equation-label">(17)</span>
                $$\beta_j = z_j \cdot \tau \cdot \tilde{\lambda}_j, \quad \tau_0 = \frac{D_0}{D - D_0} \cdot \frac{\sigma}{\sqrt{N}}$$
            </div>

            <h3 id="vs-spike-slab">Spike-and-Slab Prior</h3>
            <div class="math-block">
                <span class="equation-label">(18)</span>
                $$\beta_j = \gamma_j \cdot \beta_{\text{slab},j} + (1 - \gamma_j) \cdot \beta_{\text{spike},j}$$
            </div>

            <h3 id="vs-lasso">Bayesian LASSO</h3>
            <div class="math-block">
                <span class="equation-label">(19)</span>
                $$\beta_j | \sigma^2, \lambda^2 \sim \mathcal{N}(0, \sigma^2 \tau_j^2), \quad \tau_j^2 \sim \text{Exp}(\lambda^2/2)$$
            </div>

            <h3 id="vs-interpretation">Interpreting Results</h3>
            <table>
                <thead><tr><th>PIP Range</th><th>Interpretation</th></tr></thead>
                <tbody>
                    <tr><td>> 0.75</td><td>Strong evidence of effect</td></tr>
                    <tr><td>0.50 - 0.75</td><td>Moderate evidence</td></tr>
                    <tr><td>0.25 - 0.50</td><td>Weak evidence</td></tr>
                    <tr><td>< 0.25</td><td>Little evidence of effect</td></tr>
                </tbody>
            </table>

            <h2 id="diagnostics">Model Diagnostics</h2>
            
            <h3>Convergence Diagnostics</h3>
            <table>
                <thead><tr><th>Diagnostic</th><th>Target</th><th>Interpretation</th></tr></thead>
                <tbody>
                    <tr><td><strong>$\hat{R}$</strong></td><td>< 1.01</td><td>Chains converged</td></tr>
                    <tr><td><strong>ESS</strong></td><td>> 400</td><td>Sufficient independent samples</td></tr>
                    <tr><td><strong>Divergences</strong></td><td>0</td><td>No pathological behavior</td></tr>
                    <tr><td><strong>Tree Depth</strong></td><td>< max</td><td>Not hitting limits</td></tr>
                </tbody>
            </table>

            <h3 id="diagnostics-ident">Identifiability Checks</h3>
            <ul>
                <li><strong>Prior-posterior overlap:</strong> Wide overlap suggests weak identification</li>
                <li><strong>Posterior correlations:</strong> High correlation indicates potential redundancy</li>
                <li><strong>Posterior predictive checks:</strong> Does the model reproduce observed patterns?</li>
            </ul>

            <h3 id="diagnostics-comparison">Model Comparison</h3>
            <table>
                <thead><tr><th>Metric</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td><strong>WAIC</strong></td><td>Widely Applicable Information Criterion</td></tr>
                    <tr><td><strong>LOO-CV</strong></td><td>Leave-One-Out Cross-Validation</td></tr>
                    <tr><td><strong>Out-of-sample RMSE</strong></td><td>Prediction error on held-out data</td></tr>
                </tbody>
            </table>

            <h3>Computational Scaling</h3>
            <table>
                <thead><tr><th>Component</th><th>Cost Multiplier</th></tr></thead>
                <tbody>
                    <tr><td>Additional mediator</td><td>~1.3√ó</td></tr>
                    <tr><td>Additional outcome</td><td>~1.5√ó</td></tr>
                    <tr><td>Cross-effects</td><td>~1.1√ó</td></tr>
                    <tr><td>Partial observation</td><td>~1.2√ó</td></tr>
                    <tr><td>Hierarchical pooling</td><td>~1.5√ó</td></tr>
                </tbody>
            </table>

            <div class="note">
                <h4>üí° Performance Tip</h4>
                <p>For complex models, use <code>nuts_sampler="numpyro"</code> for 4-10√ó speedup via JAX.</p>
            </div>

        </main>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            flowchart: {
                curve: 'basis',
                padding: 15,
                useMaxWidth: true
            }
        });

        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ],
                throwOnError: false
            });
        });
    </script>
</body>
</html>